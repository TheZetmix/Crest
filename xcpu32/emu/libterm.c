#include <stdlib.h>
#include "libterm.h"
#include <string.h>
#include <stdio.h>

static const uint8_t font_bitmap[128][8] = {
    [31] = {0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff},

    // 32: Space
    [' '] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},

    // 33: !
    ['!'] = {0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x00},
    
    // 34: "
    ['"'] = {0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00},
    
    // 35: #
    ['#'] = {0x66, 0x66, 0xFF, 0x66, 0xFF, 0x66, 0x66, 0x00},
    
    // 36: $
    ['$'] = {0x18, 0x3E, 0x60, 0x3C, 0x06, 0x7C, 0x18, 0x00},
    
    // 37: %
    ['%'] = {0x62, 0x66, 0x0C, 0x18, 0x30, 0x66, 0x46, 0x00},
    
    // 38: &
    ['&'] = {0x3C, 0x66, 0x3C, 0x38, 0x67, 0x66, 0x3F, 0x00},
    
    // 39: '
    ['\''] = {0x18, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00},
    
    // 40: (
    ['('] = {0x0C, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00},
    
    // 41: )
    [')'] = {0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00},
    
    // 42: *
    ['*'] = {0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00},
    
    // 43: +
    ['+'] = {0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00},
    
    // 44: ,
    [','] = {0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30, 0x00},
    
    // 45: -
    ['-'] = {0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00},
    
    // 46: .
    ['.'] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00},
    
    // 47: /
    ['/'] = {0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x40, 0x00},
    
    // Цифры 0-9
    ['0'] = {0x3C, 0x66, 0x6E, 0x76, 0x66, 0x66, 0x3C, 0x00},
    ['1'] = {0x18, 0x38, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00},
    ['2'] = {0x3C, 0x66, 0x06, 0x0C, 0x30, 0x60, 0x7E, 0x00},
    ['3'] = {0x3C, 0x66, 0x06, 0x1C, 0x06, 0x66, 0x3C, 0x00},
    ['4'] = {0x0C, 0x1C, 0x3C, 0x6C, 0x7E, 0x0C, 0x0C, 0x00},
    ['5'] = {0x7E, 0x60, 0x7C, 0x06, 0x06, 0x66, 0x3C, 0x00},
    ['6'] = {0x1C, 0x30, 0x60, 0x7C, 0x66, 0x66, 0x3C, 0x00},
    ['7'] = {0x7E, 0x06, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00},
    ['8'] = {0x3C, 0x66, 0x66, 0x3C, 0x66, 0x66, 0x3C, 0x00},
    ['9'] = {0x3C, 0x66, 0x66, 0x3E, 0x06, 0x0C, 0x38, 0x00},
    
    // 58: :
    [':'] = {0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00},
    
    // 59: ;
    [';'] = {0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x30, 0x00},
    
    // 60: <
    ['<'] = {0x06, 0x0C, 0x18, 0x30, 0x18, 0x0C, 0x06, 0x00},
    
    // 61: =
    ['='] = {0x00, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x00, 0x00},
    
    // 62: >
    ['>'] = {0x60, 0x30, 0x18, 0x0C, 0x18, 0x30, 0x60, 0x00},
    
    // 63: ?
    ['?'] = {0x3C, 0x66, 0x0C, 0x18, 0x18, 0x00, 0x18, 0x00},
    
    // 64: @
    ['@'] = {0x3C, 0x66, 0x6E, 0x6E, 0x60, 0x62, 0x3C, 0x00},
    
    // Заглавные буквы A-Z
    ['A'] = {0x18, 0x3C, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x00},
    ['B'] = {0x7C, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x7C, 0x00},
    ['C'] = {0x3C, 0x66, 0x60, 0x60, 0x60, 0x66, 0x3C, 0x00},
    ['D'] = {0x78, 0x6C, 0x66, 0x66, 0x66, 0x6C, 0x78, 0x00},
    ['E'] = {0x7E, 0x60, 0x60, 0x7C, 0x60, 0x60, 0x7E, 0x00},
    ['F'] = {0x7E, 0x60, 0x60, 0x7C, 0x60, 0x60, 0x60, 0x00},
    ['G'] = {0x3C, 0x66, 0x60, 0x6E, 0x66, 0x66, 0x3C, 0x00},
    ['H'] = {0x66, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x00},
    ['I'] = {0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00},
    ['J'] = {0x3E, 0x0C, 0x0C, 0x0C, 0x0C, 0x6C, 0x38, 0x00},
    ['K'] = {0x66, 0x6C, 0x78, 0x70, 0x78, 0x6C, 0x66, 0x00},
    ['L'] = {0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x00},
    ['M'] = {0x63, 0x77, 0x7F, 0x6B, 0x6B, 0x63, 0x63, 0x00},
    ['N'] = {0x66, 0x76, 0x7E, 0x7E, 0x6E, 0x66, 0x66, 0x00},
    ['O'] = {0x3C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00},
    ['P'] = {0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60, 0x60, 0x00},
    ['Q'] = {0x3C, 0x66, 0x66, 0x66, 0x6A, 0x6C, 0x36, 0x00},
    ['R'] = {0x7C, 0x66, 0x66, 0x7C, 0x6C, 0x66, 0x66, 0x00},
    ['S'] = {0x3C, 0x66, 0x60, 0x3C, 0x06, 0x66, 0x3C, 0x00},
    ['T'] = {0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00},
    ['U'] = {0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00},
    ['V'] = {0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00},
    ['W'] = {0x63, 0x63, 0x6B, 0x6B, 0x7F, 0x77, 0x63, 0x00},
    ['X'] = {0x66, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x66, 0x00},
    ['Y'] = {0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x00},
    ['Z'] = {0x7E, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x7E, 0x00},
    
    // 91: [
    ['['] = {0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00},
    
    // 92: backslash
    ['\\'] = {0x40, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x02, 0x00},
    
    // 93: ]
    [']'] = {0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00},
    
    // 94: ^
    ['^'] = {0x18, 0x3C, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00},
    
    // 95: _
    ['_'] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00},
    
    // 96: `
    ['`'] = {0x18, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00},
    
    // Строчные буквы a-z
    ['a'] = {0x00, 0x00, 0x3C, 0x06, 0x3E, 0x66, 0x3E, 0x00},
    ['b'] = {0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x00},
    ['c'] = {0x00, 0x00, 0x3C, 0x66, 0x60, 0x66, 0x3C, 0x00},
    ['d'] = {0x06, 0x06, 0x3E, 0x66, 0x66, 0x66, 0x3E, 0x00},
    ['e'] = {0x00, 0x00, 0x3C, 0x66, 0x7E, 0x60, 0x3C, 0x00},
    ['f'] = {0x1C, 0x30, 0x7C, 0x30, 0x30, 0x30, 0x30, 0x00},
    ['g'] = {0x00, 0x00, 0x3E, 0x66, 0x66, 0x3E, 0x06, 0x3C},
    ['h'] = {0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x00},
    ['i'] = {0x18, 0x00, 0x18, 0x18, 0x18, 0x18, 0x0C, 0x00},
    ['j'] = {0x0C, 0x00, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x38},
    ['k'] = {0x60, 0x60, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0x00},
    ['l'] = {0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x0C, 0x00},
    ['m'] = {0x00, 0x00, 0x76, 0x7F, 0x6B, 0x6B, 0x63, 0x00},
    ['n'] = {0x00, 0x00, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x00},
    ['o'] = {0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x3C, 0x00},
    ['p'] = {0x00, 0x00, 0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60},
    ['q'] = {0x00, 0x00, 0x3E, 0x66, 0x66, 0x3E, 0x06, 0x06},
    ['r'] = {0x00, 0x00, 0x7C, 0x66, 0x60, 0x60, 0x60, 0x00},
    ['s'] = {0x00, 0x00, 0x3E, 0x60, 0x3C, 0x06, 0x7C, 0x00},
    ['t'] = {0x30, 0x30, 0x7C, 0x30, 0x30, 0x30, 0x1C, 0x00},
    ['u'] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x00},
    ['v'] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00},
    ['w'] = {0x00, 0x00, 0x63, 0x6B, 0x6B, 0x7F, 0x36, 0x00},
    ['x'] = {0x00, 0x00, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x00},
    ['y'] = {0x00, 0x00, 0x66, 0x66, 0x66, 0x3E, 0x06, 0x3C},
    ['z'] = {0x00, 0x00, 0x7E, 0x0C, 0x18, 0x30, 0x7E, 0x00},
    
    // 123: {
    ['{'] = {0x0E, 0x18, 0x18, 0x70, 0x18, 0x18, 0x0E, 0x00},
    
    // 124: |
    ['|'] = {0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00},
    
    // 125: }
    ['}'] = {0x70, 0x18, 0x18, 0x0E, 0x18, 0x18, 0x70, 0x00},
    
    // 126: ~
    ['~'] = {0x00, 0x00, 0x3B, 0x6E, 0x00, 0x00, 0x00, 0x00},
    
    // 127: DEL
    [127] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
};

X11Context* x11_init(int width, int height, const char* title) {
    X11Context* ctx = malloc(sizeof(X11Context));
    ctx->display = XOpenDisplay(NULL);
    if (!ctx->display) {
        free(ctx);
        return NULL;
    }

    int screen = DefaultScreen(ctx->display);
    Window root = RootWindow(ctx->display, screen);

    // Устанавливаем минимальные/максимальные размеры (опционально)
    XSizeHints hints;
    hints.flags = PMinSize | PMaxSize;
    hints.min_width = hints.max_width = width;
    hints.min_height = hints.max_height = height;

    ctx->window = XCreateSimpleWindow(
        ctx->display, root,
        hints.max_width/2, hints.max_height/2, width, height, 0,
        BlackPixel(ctx->display, screen),
        WhitePixel(ctx->display, screen)
    );

    XSetStandardProperties(ctx->display, ctx->window, title, title, None, NULL, 0, &hints);
    XSelectInput(ctx->display, ctx->window, ExposureMask | KeyPressMask);
    XMapWindow(ctx->display, ctx->window);

    // Ждём, пока окно появится
    XEvent ev;
    while (1) {
        XNextEvent(ctx->display, &ev);
        if (ev.type == Expose) break;
    }

    ctx->gc = XCreateGC(ctx->display, ctx->window, 0, NULL);
    XSetForeground(ctx->display, ctx->gc, BlackPixel(ctx->display, screen));

    ctx->width = width;
    ctx->height = height;

    // Создаём буфер с теми же размерами
    ctx->buffer = XCreatePixmap(ctx->display, ctx->window, width, height, DefaultDepth(ctx->display, screen));

    // Очищаем буфер белым цветом
    XSetForeground(ctx->display, ctx->gc, WhitePixel(ctx->display, screen));
    XFillRectangle(ctx->display, ctx->buffer, ctx->gc, 0, 0, width, height);
    XFlush(ctx->display);

    return ctx;
}

void x11_close(X11Context* ctx) {
    if (!ctx) return;
    XFreePixmap(ctx->display, ctx->buffer);
    XFreeGC(ctx->display, ctx->gc);
    XDestroyWindow(ctx->display, ctx->window);
    XCloseDisplay(ctx->display);
    free(ctx->pixels);
    free(ctx);
}

void x11_fill(X11Context* ctx, uint8_t r, uint8_t g, uint8_t b) {
    unsigned long pixel = (r << 16) | (g << 8) | b;
    XSetForeground(ctx->display, ctx->gc, pixel);
    XFillRectangle(ctx->display, ctx->buffer, ctx->gc, 0, 0, ctx->width, ctx->height);
    XCopyArea(ctx->display, ctx->buffer, ctx->window, ctx->gc, 
              0, 0, ctx->width, ctx->height, 0, 0);
    XFlush(ctx->display);
}

void x11_flush(X11Context* ctx) {
    XCopyArea(ctx->display, ctx->buffer, ctx->window, ctx->gc, 
              0, 0, ctx->width, ctx->height, 0, 0);
    XFlush(ctx->display);
}

void x11_draw_pixel(X11Context* ctx, int x, int y, uint8_t r, uint8_t g, uint8_t b) {
    if (x < 0 || x >= ctx->width || y < 0 || y >= ctx->height) return;
    XSetForeground(ctx->display, ctx->gc, (r << 16) | (g << 8) | b);
    XDrawPoint(ctx->display, ctx->buffer, ctx->gc, x, y);
}

void x11_draw_char(X11Context* ctx, int x, int y, char c, uint8_t r, uint8_t g, uint8_t b) {
    int char_size = ctx->char_size;
    uint32_t bg_color = ctx->bg_color;
    uint32_t fg_color = (r << 16) | (g << 8) | b; // Цвет символа

    // 1. Заливаем область символа фоновым цветом (затираем предыдущее содержимое)
    XSetForeground(ctx->display, ctx->gc, bg_color);
    XFillRectangle(
        ctx->display, ctx->buffer, ctx->gc,
        x * char_size,
        y * char_size,
        char_size * 8, char_size * 8 // Размер символа: 8x8 пикселей (масштабируется)
    );

    // 2. Рисуем новый символ
    XSetForeground(ctx->display, ctx->gc, fg_color);
    for (int row = 0; row < 8; row++) {
        uint8_t row_data = font_bitmap[(int)c][row];
        for (int col = 0; col < 8; col++) {
            if (row_data & (1 << (7 - col))) {
                XFillRectangle(
                    ctx->display, ctx->buffer, ctx->gc,
                    (x + col) * char_size,
                    (y + row) * char_size,
                    char_size, char_size
                );
            }
        }
    }
}

int x11_key_pressed(X11Context* ctx, char* key) {
    XEvent event;
    if (XPending(ctx->display)) {
        XNextEvent(ctx->display, &event);
        if (event.type == KeyPress) {
            *key = XLookupKeysym(&event.xkey, 0);
            return 1;
        }
    }
    return 0;
}

int x11_get_mouse_coords(X11Context* ctx, int* x, int* y) {
    Window root, child;
    int root_x, root_y, win_x, win_y;
    unsigned int mask;
    
    Bool result = XQueryPointer(
        ctx->display, 
        ctx->window,
        &root, 
        &child,
        &root_x, 
        &root_y,
        &win_x, 
        &win_y,
        &mask
    );
    
    if (result == True) {
        *x = win_x;  // Координаты относительно окна
        *y = win_y;
        return 1;
    }
    
    return 0;
}
